# å»£æ¸…å®®è¨˜å¸³è»Ÿé«” - ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²æµç¨‹
name: Production Deployment

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ä»£ç¢¼å“è³ªæª¢æŸ¥
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install

      - name: Run system check
        run: node tests/simple-check.mjs

      - name: Check build configuration
        run: |
          echo "Checking production configuration..."
          if [ -f ".env.production.example" ]; then
            echo "âœ… Production environment template found"
          else
            echo "âš ï¸ Production environment template missing"
          fi

  # å»ºç½®å’Œæ¸¬è©¦
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: quality-check
    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          BUILD_NUMBER="${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Build: $BUILD_NUMBER"

      - name: Build application
        env:
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
          VITE_APP_BUILD_NUMBER: ${{ steps.version.outputs.build-number }}
          VITE_APP_COMMIT_SHA: ${{ github.sha }}
          NODE_ENV: production
        run: npm run build

      - name: Validate build
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed - dist directory not found"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed - index.html not found"
            exit 1
          fi
          
          # æª¢æŸ¥å»ºç½®æª”æ¡ˆå¤§å°
          BUILD_SIZE=$(du -sh dist | cut -f1)
          echo "ğŸ“¦ Build size: $BUILD_SIZE"
          
          # æª¢æŸ¥æ˜¯å¦åŒ…å«æ‡‰ç”¨æ¨™é¡Œ
          if grep -q "å»£æ¸…å®®" dist/index.html; then
            echo "âœ… Application title found in build"
          else
            echo "âš ï¸ Application title not found in build"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files-${{ steps.version.outputs.version }}
          path: dist/
          retention-days: 30

  # Docker æ˜ åƒå»ºç½®
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.build-and-test.outputs.version }}
            BUILD_NUMBER=${{ needs.build-and-test.outputs.build-number }}

  # éƒ¨ç½²åˆ° Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-test, build-docker]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.temple-accounting.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files-${{ needs.build-and-test.outputs.version }}
          path: dist/

      - name: Deploy to Firebase Hosting (Staging)
        if: vars.FIREBASE_PROJECT_STAGING
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}'
          projectId: ${{ vars.FIREBASE_PROJECT_STAGING }}
          channelId: live

      - name: Deploy to custom staging server
        if: vars.STAGING_SERVER
        run: |
          echo "ğŸš€ Deploying to staging server..."
          # é€™è£¡å¯ä»¥æ·»åŠ è‡ªå®šç¾©éƒ¨ç½²é‚è¼¯
          echo "Staging deployment completed"

      - name: Run staging tests
        run: |
          echo "ğŸ§ª Running staging tests..."
          sleep 30
          
          # æª¢æŸ¥å¥åº·ç«¯é»
          if [ -n "${{ vars.STAGING_URL }}" ]; then
            curl -f ${{ vars.STAGING_URL }}/health || echo "âš ï¸ Health check failed"
            curl -f ${{ vars.STAGING_URL }}/ | grep -q "å»£æ¸…å®®" || echo "âš ï¸ App content check failed"
          fi

      - name: Notify staging deployment
        if: success()
        run: |
          echo "âœ… Staging deployment successful"
          echo "ğŸ”— URL: ${{ vars.STAGING_URL || 'https://staging.temple-accounting.com' }}"

  # éƒ¨ç½²åˆ° Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-test, build-docker, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://accounting.temple.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files-${{ needs.build-and-test.outputs.version }}
          path: dist/

      - name: Deploy to Firebase Hosting (Production)
        if: vars.FIREBASE_PROJECT_PRODUCTION
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRODUCTION }}'
          projectId: ${{ vars.FIREBASE_PROJECT_PRODUCTION }}
          channelId: live

      - name: Deploy to custom production server
        if: vars.PRODUCTION_SERVER
        run: |
          echo "ğŸš€ Deploying to production server..."
          
          # è¨­å®š SSH (å¦‚æœéœ€è¦)
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            mkdir -p ~/.ssh
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -H ${{ vars.PRODUCTION_SERVER }} >> ~/.ssh/known_hosts
            
            # ä½¿ç”¨ rsync éƒ¨ç½²
            rsync -avz --delete dist/ ${{ vars.DEPLOY_USER }}@${{ vars.PRODUCTION_SERVER }}:${{ vars.DEPLOY_PATH }}
            
            # é‡å•Ÿæœå‹™
            ssh ${{ vars.DEPLOY_USER }}@${{ vars.PRODUCTION_SERVER }} "sudo systemctl reload nginx"
          fi

      - name: Run production tests
        run: |
          echo "ğŸ§ª Running production tests..."
          sleep 60
          
          # æª¢æŸ¥ç”Ÿç”¢ç’°å¢ƒ
          if [ -n "${{ vars.PRODUCTION_URL }}" ]; then
            curl -f ${{ vars.PRODUCTION_URL }}/health || exit 1
            curl -f ${{ vars.PRODUCTION_URL }}/ | grep -q "å»£æ¸…å®®" || exit 1
            
            # æª¢æŸ¥ HTTPS å®‰å…¨æ¨™é ­
            curl -I ${{ vars.PRODUCTION_URL }}/ | grep -q "Strict-Transport-Security" || echo "âš ï¸ HSTS header missing"
            curl -I ${{ vars.PRODUCTION_URL }}/ | grep -q "X-Content-Type-Options" || echo "âš ï¸ X-Content-Type-Options header missing"
          fi

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: å»£æ¸…å®®è¨˜å¸³è»Ÿé«” ${{ github.ref }}
          body: |
            ## ğŸ‰ å»£æ¸…å®®è¨˜å¸³è»Ÿé«” ${{ github.ref }} ç™¼å¸ƒ
            
            ### ğŸ“‹ ç‰ˆæœ¬è³‡è¨Š
            - **ç‰ˆæœ¬**: ${{ needs.build-and-test.outputs.version }}
            - **å»ºç½®ç·¨è™Ÿ**: ${{ needs.build-and-test.outputs.build-number }}
            - **æäº¤**: ${{ github.sha }}
            - **ç™¼å¸ƒæ™‚é–“**: ${{ github.event.head_commit.timestamp }}
            
            ### ğŸ”— é€£çµ
            - [ç”Ÿç”¢ç’°å¢ƒ](https://accounting.temple.com)
            - [ä½¿ç”¨æ–‡æª”](https://github.com/${{ github.repository }}/blob/main/README.md)
            
            ### ğŸ“¦ éƒ¨ç½²è³‡è¨Š
            - Firebase Hosting: âœ…
            - Docker Image: âœ…
            - å¥åº·æª¢æŸ¥: âœ…
            
            **å®Œæ•´è®Šæ›´æ—¥èªŒ**: https://github.com/${{ github.repository }}/compare/v1.0.0...${{ github.ref }}
          draft: false
          prerelease: false

      - name: Notify production deployment
        if: success()
        run: |
          echo "ğŸ‰ Production deployment successful!"
          echo "ğŸ“Š Version: ${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ”¢ Build: ${{ needs.build-and-test.outputs.build-number }}"
          echo "ğŸ”— URL: ${{ vars.PRODUCTION_URL || 'https://accounting.temple.com' }}"

  # éƒ¨ç½²å¤±æ•—è™•ç†
  deployment-failure:
    name: Handle Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure()
    steps:
      - name: Rollback procedures
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ”„ Initiating rollback procedures..."
          
          # é€™è£¡å¯ä»¥æ·»åŠ è‡ªå‹•å›æ»¾é‚è¼¯
          # ä¾‹å¦‚ï¼šæ¢å¾©åˆ°ä¸Šä¸€å€‹ç©©å®šç‰ˆæœ¬
          
          echo "ğŸ“§ Notifying development team..."
          echo "ğŸ“‹ Please check deployment logs and take appropriate action."

      - name: Create failure issue
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ éƒ¨ç½²å¤±æ•— - ${context.sha.substring(0, 7)}`,
              body: `## éƒ¨ç½²å¤±æ•—å ±å‘Š
              
              **æäº¤**: ${context.sha}
              **åˆ†æ”¯**: ${context.ref}
              **æ™‚é–“**: ${new Date().toISOString()}
              **å·¥ä½œæµç¨‹**: ${context.workflow}
              
              è«‹æª¢æŸ¥ [å·¥ä½œæµç¨‹æ—¥èªŒ](${context.payload.repository.html_url}/actions/runs/${context.runId}) ä»¥äº†è§£å¤±æ•—åŸå› ã€‚
              
              ### å»ºè­°è¡Œå‹•
              1. æª¢æŸ¥å»ºç½®æ—¥èªŒ
              2. é©—è­‰ç’°å¢ƒé…ç½®
              3. æ¸¬è©¦æœ¬åœ°å»ºç½®
              4. ä¿®å¾©å•é¡Œå¾Œé‡æ–°éƒ¨ç½²
              `,
              labels: ['bug', 'deployment', 'urgent']
            })
